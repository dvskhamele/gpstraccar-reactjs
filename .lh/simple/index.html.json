{
    "sourceFile": "simple/index.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765380742405,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765380753629,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,9 +2,9 @@\n <html lang=\"en\">\r\n <head>\r\n <meta charset=\"UTF-8\">\r\n <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n-<title>Track Fasst</title>\r\n+<title>Track Fas</title>\r\n <link href=\"https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css\" rel=\"stylesheet\">\r\n <link href=\"https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css\" rel=\"stylesheet\">\r\n </head>\r\n <body style=\"margin: 0; padding: 0;\">\r\n"
                }
            ],
            "date": 1765380742405,
            "name": "Commit-0",
            "content": "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n<meta charset=\"UTF-8\">\r\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n<title></title>\r\n<link href=\"https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css\" rel=\"stylesheet\">\r\n<link href=\"https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css\" rel=\"stylesheet\">\r\n</head>\r\n<body style=\"margin: 0; padding: 0;\">\r\n<div id=\"content\" style=\"width: 100%; height: 100%; position:fixed;\"></div>\r\n<script src=\"https://unpkg.com/react@17/umd/react.development.js\"></script>\r\n<script src=\"https://unpkg.com/react-dom@17/umd/react-dom.development.js\"></script>\r\n<script src=\"https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js\"></script>\r\n<script src=\"https://unpkg.com/@babel/standalone/babel.min.js\"></script>\r\n<script type=\"text/babel\">\r\n\r\n  const LoginScreen = ({ server, setServer, setUser }) => {\r\n    const [email, setEmail] = React.useState('');\r\n    const [password, setPassword] = React.useState('');\r\n\r\n    const handleSubmit = (event) => {\r\n      event.preventDefault();\r\n      const fetchData = async () => {\r\n        if (server.newServer) {\r\n          const response = await fetch('/api/users', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({ name: email, email, password }),\r\n          });\r\n          if (response.ok) {\r\n            setServer({ ...server, newServer: false });\r\n          }\r\n        } else {\r\n          const query = `email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;\r\n          const response = await fetch('/api/session', {\r\n            method: 'POST',\r\n            body: new URLSearchParams(query),\r\n          });\r\n          if (response.ok) {\r\n            setUser(await response.json());\r\n          }\r\n        }\r\n      }\r\n      fetchData();\r\n    };\r\n\r\n    const formStyle = {\r\n      width: '320px',\r\n      margin: '32px',\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n    };\r\n\r\n    return (\r\n      <form onSubmit={handleSubmit} style={formStyle}>\r\n        <input\r\n          value={email}\r\n          onChange={(e) => setEmail(e.target.value)}\r\n          placeholder=\"Email\"\r\n        />\r\n        <input\r\n          password={password}\r\n          onChange={(e) => setPassword(e.target.value)}\r\n          placeholder=\"Password\"\r\n          type=\"password\"\r\n        />\r\n        <button type=\"submit\">\r\n          {server.newServer ? 'Register' : 'Login'}\r\n        </button>\r\n      </form>\r\n    );\r\n  };\r\n\r\n  const MainScreen = ({ setUser }) => {\r\n    const mapContainer = React.useRef();\r\n    const map = React.useRef();\r\n\r\n    React.useEffect(() => {\r\n      map.current = new maplibregl.Map({\r\n        container: mapContainer.current,\r\n        style: 'https://demotiles.maplibre.org/style.json',\r\n        center: [0, 0],\r\n        zoom: 1,\r\n      });\r\n    }, []);\r\n\r\n    const [devices, setDevices] = React.useState([]);\r\n\r\n    React.useEffect(() => {\r\n      const fetchData = async () => {\r\n        const devicesResponse = await fetch('/api/devices');\r\n        if (devicesResponse.ok) {\r\n          setDevices(await devicesResponse.json());\r\n        }\r\n      }\r\n      fetchData();\r\n    }, []);\r\n\r\n    const [initialized, setInitialized] = React.useState(false);\r\n    const [positions, setPositions] = React.useState({});\r\n\r\n    React.useEffect(() => {\r\n      if (initialized) {\r\n        const url = window.location.protocol + '//' + window.location.host;\r\n        const socket = new WebSocket('ws' + url.substring(4) + '/api/socket');\r\n        socket.onmessage = (event) => {\r\n          const data = JSON.parse(event.data);\r\n          const updatedPositions = {};\r\n          data.positions?.forEach((p) => updatedPositions[p.deviceId] = p);\r\n          setPositions({ ...positions, ...updatedPositions })\r\n        };\r\n      }\r\n    }, [initialized]);\r\n\r\n    const handleAddDevice = (event) => {\r\n      event.preventDefault();\r\n      const fetchData = async () => {\r\n        const id = prompt('Enter device id');\r\n        const response = await fetch('/api/devices', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            name: id,\r\n            uniqueId: id,\r\n          }),\r\n        });\r\n        if (response.ok) {\r\n          setDevices([...devices, await response.json()]);\r\n        }\r\n      }\r\n      fetchData();\r\n    };\r\n\r\n    const handleLogout = (event) => {\r\n      event.preventDefault();\r\n      const fetchData = async () => {\r\n        await fetch('/api/session', { method: 'DELETE' });\r\n        setUser(null);\r\n      }\r\n      fetchData();\r\n    };\r\n\r\n    React.useEffect(() => {\r\n      map.current.on('load', () => {\r\n        map.current.addSource('points', {\r\n          type: 'geojson',\r\n          data: {\r\n            type: 'FeatureCollection',\r\n            features: [],\r\n          },\r\n        });\r\n        map.current.addLayer({\r\n          id: 'points',\r\n          type: 'circle',\r\n          source: 'points',\r\n        });\r\n        setInitialized(true);\r\n      });\r\n    }, []);\r\n\r\n    React.useEffect(() => {\r\n      map.current.getSource('points')?.setData({\r\n        type: 'FeatureCollection',\r\n        features: Object.values(positions).map((position) => ({\r\n          type: 'Feature',\r\n          geometry: {\r\n            type: 'Point',\r\n            coordinates: [position.longitude, position.latitude],\r\n          },\r\n        })),\r\n      });\r\n    }, [positions]);\r\n\r\n    const containerStyle = {\r\n      width: '100%',\r\n      height: '100%',\r\n      display: 'flex',\r\n    };\r\n    const deviceStyle = {\r\n      width: '320px',\r\n      marginTop: '16px',\r\n    };\r\n    const mapStyle = {\r\n      height: '100%',\r\n      flexGrow: 1,\r\n    };\r\n\r\n    return (\r\n      <div style={containerStyle}>\r\n        <div style={deviceStyle}>\r\n          <ul>\r\n            {devices?.map((device) => (<li key={device.id}>{device.name}</li>))}\r\n            <li><a href=\"#\" onClick={handleAddDevice}>Add device</a></li>\r\n            <li><a href=\"#\" onClick={handleLogout}>Logout</a></li>\r\n          </ul>\r\n        </div>\r\n        <div style={mapStyle} ref={mapContainer}></div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const App = () => {\r\n    const [server, setServer] = React.useState();\r\n    const [user, setUser] = React.useState();\r\n\r\n    React.useEffect(() => {\r\n      const fetchData = async () => {\r\n        const serverResponse = await fetch('/api/server');\r\n        if (serverResponse.ok) {\r\n          setServer(await serverResponse.json());\r\n        }\r\n        const sessionResponse = await fetch('/api/session');\r\n        if (sessionResponse.ok) {\r\n          setUser(await sessionResponse.json());\r\n        }\r\n      }\r\n      fetchData();\r\n    }, []);\r\n\r\n    return user ? (\r\n      <MainScreen\r\n        setUser={setUser}\r\n      />\r\n    ) : server ? (\r\n      <LoginScreen\r\n        server={server}\r\n        setServer={setServer}\r\n        setUser={setUser}\r\n      />\r\n    ) : '';\r\n  };\r\n\r\n  ReactDOM.render(<App />, document.getElementById('content'));\r\n\r\n</script>\r\n</body>\r\n</html>\r\n"
        }
    ]
}