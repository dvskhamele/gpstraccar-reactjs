import React, { useState } from "react";
import dayjs from "dayjs";
import { useDispatch, useSelector } from "react-redux";
import { useNavigate, Link as RouterLink } from "react-router-dom";
import { Rnd } from "react-rnd";
import {
  Card,
  CardContent,
  Typography,
  CardActions,
  IconButton,
  Menu,
  MenuItem,
  CardMedia,
  Link,
  Tooltip,
  Box,
  Grid,
  Divider,
  Stack,
  Chip,
  Avatar,
  LinearProgress,
  CircularProgress,
} from "@mui/material";
import { makeStyles } from "tss-react/mui";
import CloseIcon from "@mui/icons-material/Close";
import RouteIcon from "@mui/icons-material/Route";
import SendIcon from "@mui/icons-material/Send";
import EditIcon from "@mui/icons-material/Edit";
import DeleteIcon from "@mui/icons-material/Delete";
import SpeedIcon from "@mui/icons-material/Speed";
import RoomIcon from "@mui/icons-material/Room";
import AccessTimeIcon from "@mui/icons-material/AccessTime";
import MyLocationIcon from "@mui/icons-material/MyLocation";
import ExploreIcon from "@mui/icons-material/Explore";
import PowerIcon from "@mui/icons-material/Power";
import DirectionsCarIcon from "@mui/icons-material/DirectionsCar";
import AvTimerIcon from "@mui/icons-material/AvTimer";
import AlarmIcon from "@mui/icons-material/Alarm";
import InfoOutlinedIcon from "@mui/icons-material/InfoOutlined";
import LocationSearchingIcon from "@mui/icons-material/LocationSearching";
import LocalGasStationIcon from "@mui/icons-material/LocalGasStation";
import VpnKeyIcon from "@mui/icons-material/VpnKey";
import CodeIcon from "@mui/icons-material/Code";
import TerrainIcon from "@mui/icons-material/Terrain";
import TuneIcon from "@mui/icons-material/Tune";

import { useTranslation } from "./LocalizationProvider";
import RemoveDialog from "./RemoveDialog";
import PositionValue from "./PositionValue";
import { useDeviceReadonly, useRestriction } from "../util/permissions";
import usePositionAttributes from "../attributes/usePositionAttributes";
import { devicesActions } from "../../store";
import { useCatch, useCatchCallback } from "../../reactHelper";
import { useAttributePreference } from "../util/preferences";
import fetchOrThrow from "../util/fetchOrThrow";
import VehicleNumberPlate from "./VehicleNumberPlate";
import { formatDistance, formatTime } from "../util/formatter";
import AddressValue from "./AddressValue";
import BatteryIcon from "./BatteryIcon";
import RssiIcon from "./RssiIcon";

const useStyles = makeStyles()((theme, { desktopPadding }) => ({
  card: {
    pointerEvents: "auto",
    width: "100%",
    [theme.breakpoints.up("md")]: {
      width: "auto",
      maxWidth: 1200, // Increased width to fit more content
      minHeight: 320, // Increased height to accommodate larger elements
      maxHeight: 420, // Allow more height
    },
    [theme.breakpoints.down("md")]: {
      width: "100%",
      maxWidth: "100%",
      minHeight: "30vh", // Reduced height for mobile
      maxHeight: "40vh", // Reduced height for mobile
      margin: 0,
      borderRadius: theme.spacing(3), // More rounded corners for premium look
      boxShadow: "0px -8px 24px rgba(0,0,0,0.15)", // Enhanced shadow for premium look
    },
    borderRadius: theme.spacing(2),
    boxShadow: "0 8px 24px rgba(0,0,0,0.12)",
    display: "flex",
    flexDirection: "column",
    overflow: "hidden", // Ensure content doesn't overflow
  },
  header: {
    padding: theme.spacing(1.5),
    display: "flex",
    justifyContent: "space-between",
    alignItems: "flex-start",
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[900]
        : theme.palette.grey[100],
    borderBottom: `1px solid ${theme.palette.divider}`,
    borderRadius: theme.spacing(2, 2, 0, 0), // Rounded top corners only
    [theme.breakpoints.down("md")]: {
      position: "sticky",
      top: 0,
      zIndex: 2,
      backgroundColor: theme.palette.background.paper,
    },
  },
  headerButton: {
    alignSelf: "flex-start",
    flexShrink: 0,
  },
  headerContent: {
    display: "flex",
    flexDirection: "column",
    alignItems: "flex-start",
    gap: theme.spacing(1),
    flex: 1,
    minWidth: 0,
  },
  headerTopRow: {
    display: "flex",
    alignItems: "center",
    gap: theme.spacing(1),
    width: "100%",
    flexWrap: "wrap", // Wrap items on small screens
  },
  deviceName: {
    fontWeight: 700,
    fontSize: "1.2rem",
    color: theme.palette.primary.main,
    whiteSpace: "nowrap",
    overflow: "hidden",
    textOverflow: "ellipsis",
    flexGrow: 1,
  },
  vehiclePlate: {
    flexShrink: 0,
  },
  statusChip: {
    height: 24,
    fontSize: "0.75rem",
    fontWeight: 600,
    flexShrink: 0,
  },
  addressContainer: {
    display: "flex",
    alignItems: "center",
    gap: theme.spacing(0.5),
    width: "100%",
    minWidth: 0, // Allows flex child to shrink below content size
    flexWrap: "wrap", // Allow wrapping on small screens
    wordBreak: "break-word", // Break long addresses
    [theme.breakpoints.down("md")]: {
      flexWrap: "wrap",
      wordBreak: "break-word",
      fontSize: "0.8rem", // Slightly smaller font on mobile
    },
  },
  content: {
    padding: theme.spacing(1),
    flex: 1,
    display: "flex",
    flexDirection: "column",
    [theme.breakpoints.down("md")]: {
      maxHeight: "calc(40vh - 120px)", // Reduced based on new card height
      minHeight: "0",
      overflowY: "auto", // Enable vertical scrolling on mobile
      overflowX: "hidden", // Prevent horizontal scrolling
    },
    [theme.breakpoints.up("md")]: {
      overflowY: "auto", // Also enable on desktop for consistency
    },
  },
  mainGrid: {
    display: "grid",
    gridTemplateColumns: "140px 1fr",
    gap: theme.spacing(1),
    width: "100%",
    height: "100%",
    [theme.breakpoints.down("sm")]: {
      display: "flex",
      flexDirection: "column",
      height: "auto",
      overflowY: "auto", // Enable vertical scrolling on mobile
      overflowX: "hidden", // Prevent horizontal scrolling
    },
  },
  speedSection: {
    display: "flex",
    flexDirection: "row",
    alignItems: "flex-start", // Align to top
    justifyContent: "space-between",
    padding: theme.spacing(1),
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[900]
        : theme.palette.grey[100],
    borderRadius: theme.spacing(2),
    margin: theme.spacing(1, 0),
    [theme.breakpoints.down("sm")]: {
      display: "flex",
      flexDirection: "row", // Keep as row for side-by-side layout on mobile
      padding: theme.spacing(1), // Keep padding for mobile
      alignItems: "center", // Center items vertically
      flex: "0 0 auto", // Don't grow on mobile
      gap: theme.spacing(1), // Add gap between elements
      width: "100%", // Ensure full width on mobile
      boxSizing: "border-box", // Ensure padding is included in width calculation
    },
  },
  speedGaugeContainer: {
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    flex: "0 0 auto", // Don't grow on mobile
    padding: theme.spacing(0.5),
    [theme.breakpoints.down("sm")]: {
      flex: "0 0 calc(45% - 8px)", // Take up to 45% minus some space for gap to prevent overflow
      alignItems: "center", // Center content in the allocated space
      justifyContent: "center",
      boxSizing: "border-box", // Ensure padding is included in width calculation
    },
  },
  mobileDataBox: {
    display: "flex",
    flexDirection: "column",
    alignItems: "flex-start",
    padding: theme.spacing(1.5),
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[800]
        : theme.palette.grey[200],
    borderRadius: theme.spacing(2),
    minWidth: 140,
    width: "100%", // Full width of its allocated space
    flex: "0 0 calc(55% - 8px)", // Take up to 55% minus some space for gap to prevent overflow
    maxHeight: "150px", // Limit height to fit properly
    overflowY: "auto", // Enable scrolling if content overflows
    overflowX: "hidden", // Prevent horizontal overflow
    boxShadow:
      "0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)", // Tailwind-inspired shadow
    boxSizing: "border-box", // Ensure padding is included in width calculation
    [theme.breakpoints.up("md")]: {
      display: "none", // Hide on desktop
    },
  },
  mobileDataItem: {
    display: "flex",
    alignItems: "center",
    gap: theme.spacing(0.75),
    marginBottom: theme.spacing(1),
    padding: theme.spacing(0.25, 0.5),
    borderRadius: theme.spacing(1),
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[700]
        : theme.palette.grey[100],
    width: "100%", // Full width of parent container
    "&:last-child": {
      marginBottom: 0,
    },
  },
  mobileDataValue: {
    fontSize: "0.75rem",
    fontWeight: "600",
    color: theme.palette.text.primary,
    overflow: "hidden",
    textOverflow: "ellipsis",
    whiteSpace: "nowrap",
  },
  batteryRssiContainer: {
    display: "flex",
    gap: theme.spacing(0.5), // More compact gap
    alignItems: "center",
    [theme.breakpoints.down("sm")]: {
      flex: "0 0 auto", // Don't grow on mobile
      gap: theme.spacing(0.5), // Compact gap on mobile
    },
  },
  dataGrid: {
    display: "grid",
    gridTemplateRows: "1fr 1fr",
    gap: theme.spacing(1),
    width: "100%",
    height: "100%",
    [theme.breakpoints.down("sm")]: {
      display: "flex",
      flexDirection: "column", // Column layout for vertical scrolling
      flex: "0 0 auto", // Don't grow on mobile
      width: "100%", // Full width
      padding: theme.spacing(1, 0), // Add some padding for spacing
      boxSizing: "border-box", // Ensure padding is included in width calculation
    },
  },
  dataRow: {
    display: "flex",
    flexWrap: "wrap", // Allow items to wrap to next line
    gap: theme.spacing(1),
    width: "100%", // Ensure full width
    [theme.breakpoints.down("sm")]: {
      flexWrap: "wrap", // Allow wrapping on mobile
      flexDirection: "row", // Keep as row for side-by-side layout
      paddingBottom: theme.spacing(1),
      width: "100%", // Use full width
      justifyContent: "flex-start", // Align items to start
    },
  },
  statItem: {
    display: "flex",
    alignItems: "center",
    padding: theme.spacing(0.75),
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[800]
        : theme.palette.grey[50],
    borderRadius: theme.spacing(1.5),
    minWidth: 55, // Further reduced min width to better accommodate 3 columns
    height: 85, // Increased height for better appearance
    justifyContent: "center",
    flexDirection: "column", // Stack icon and text vertically on mobile
    textAlign: "center",
    boxShadow: "0 2px 4px rgba(0,0,0,0.05)", // Subtle shadow for depth
    boxSizing: "border-box", // Ensure padding is included in width calculation
    overflow: "hidden", // Prevent content from overflowing
    [theme.breakpoints.down("sm")]: {
      flex: "0 0 calc(33.33% - 6px)", // Three items per row with reduced gap
      height: 85, // Consistent height on mobile
      marginBottom: theme.spacing(1), // Add space between items when wrapped
    },
    [theme.breakpoints.up("md")]: {
      flexDirection: "row", // Row layout on desktop
      justifyContent: "flex-start",
      textAlign: "left",
      height: 80,
      minWidth: 100,
      padding: theme.spacing(0.75),
    },
  },
  statIcon: {
    marginRight: theme.spacing(1),
    fontSize: "1.5rem",
    minWidth: 24,
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    [theme.breakpoints.down("sm")]: {
      marginRight: 0,
      marginBottom: theme.spacing(0.5),
    },
  },
  statLabel: {
    fontSize: "0.65rem",
    color: theme.palette.text.secondary,
    whiteSpace: "nowrap",
    marginBottom: theme.spacing(0.2),
    overflow: "hidden",
    textOverflow: "ellipsis",
    maxWidth: "100%",
  },
  statValue: {
    fontWeight: 600,
    fontSize: "0.8rem",
    overflow: "hidden",
    textOverflow: "ellipsis",
    maxWidth: "100%",
  },
  statContainer: {
    padding: theme.spacing(0.5),
    flex: "1 1 120px", // Allow flex-grow, flex-shrink, and set a basis
    minWidth: 120,
    boxSizing: "border-box", // Ensure padding is included in width calculation
    [theme.breakpoints.down("sm")]: {
      flex: "0 0 auto", // Don't grow on mobile
    },
  },
  actions: {
    justifyContent: "space-around", // Space out actions evenly on mobile
    padding: theme.spacing(1, 1.5),
    backgroundColor:
      theme.palette.mode === "dark"
        ? theme.palette.grey[900]
        : theme.palette.grey[100],
    borderTop: `1px solid ${theme.palette.divider}`,
    [theme.breakpoints.down("md")]: {
      position: "sticky",
      bottom: 0,
      zIndex: 2,
      backgroundColor: theme.palette.background.paper,
    },
  },
  root: {
    pointerEvents: "none",
    position: "fixed",
    zIndex: 5,
    left: "50%",
    transform: "translateX(-50%)",
    [theme.breakpoints.up("md")]: {
      left: `calc(50% + ${desktopPadding} / 2)`,
      bottom: theme.spacing(3),
      width: "auto",
    },
    [theme.breakpoints.down("md")]: {
      bottom: theme.spacing(10), // Increased margin from bottom to move component higher
      left: theme.spacing(1),
      right: theme.spacing(1),
      width: `calc(100% - ${theme.spacing(2)})`, // Account for left and right margins (1 unit each side = 2 units total)
      transform: "none",
      maxWidth: "none",
      borderRadius: theme.spacing(2), // Rounded all corners
      boxShadow: "0px -4px 12px rgba(0,0,0,0.1)", // Shadow facing upward
    },
  },
  batteryContainer: {
    display: "flex",
    alignItems: "center",
    gap: theme.spacing(1),
  },
}));

// Custom SpeedGauge Component
const SpeedGauge = ({ speed, maxSpeed = 120 }) => {
  const percentage = Math.min(((speed || 0) / maxSpeed) * 100, 100);
  const circumference = 2 * Math.PI * 35; // increased radius for larger display
  const strokeDasharray = circumference;
  const strokeDashoffset = circumference - (percentage / 100) * circumference;

  // Determine color based on speed
  let color = "#4caf50"; // green
  if (speed > maxSpeed * 0.7) color = "#ff9800"; // orange
  if (speed > maxSpeed * 0.9) color = "#f44336"; // red

  return (
    <Box sx={{ position: "relative", width: 80, height: 80 }}>
      <svg width="80" height="80" viewBox="0 0 80 80">
        {/* Background circle */}
        <circle
          cx="40"
          cy="40"
          r="35"
          fill="none"
          stroke="#e0e0e0"
          strokeWidth="5"
        />
        {/* Progress circle */}
        <circle
          cx="40"
          cy="40"
          r="35"
          fill="none"
          stroke={color}
          strokeWidth="5"
          strokeLinecap="round"
          strokeDasharray={strokeDasharray}
          strokeDashoffset={strokeDashoffset}
          transform="rotate(-90 40 40)"
          style={{ transition: "stroke-dashoffset 0.5s ease-in-out" }}
        />
      </svg>
      <Box
        sx={{
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
        }}
      >
        <Typography
          variant="h6"
          component="div"
          sx={{
            fontWeight: "bold",
            transition: "all 0.5s ease-in-out",
          }}
        >
          {Math.round(speed || 0)}
        </Typography>
        <Typography variant="caption" component="div">
          km/h
        </Typography>
      </Box>
    </Box>
  );
};

const StatusCard = ({
  deviceId,
  position,
  onClose,
  disableActions,
  desktopPadding = 0,
}) => {
  const { classes } = useStyles({ desktopPadding });
  const distanceUnit = useAttributePreference("distanceUnit");

  const attributeIcons = {
    fixTime: <AccessTimeIcon fontSize="small" style={{ color: "#2196f3" }} />,
    deviceTime: (
      <AccessTimeIcon fontSize="small" style={{ color: "#2196f3" }} />
    ),
    serverTime: (
      <AccessTimeIcon fontSize="small" style={{ color: "#2196f3" }} />
    ),
    address: <RoomIcon fontSize="small" style={{ color: "#f44336" }} />,
    speed: <SpeedIcon fontSize="small" style={{ color: "#4caf50" }} />,
    todayDistance: (
      <DirectionsCarIcon fontSize="small" style={{ color: "#8bc34a" }} />
    ),
    todayStartTime: (
      <AccessTimeIcon fontSize="small" style={{ color: "#2196f3" }} />
    ),
    totalDistance: (
      <DirectionsCarIcon fontSize="small" style={{ color: "#8bc34a" }} />
    ),
    latitude: <MyLocationIcon fontSize="small" />,
    longitude: <MyLocationIcon fontSize="small" />,
    altitude: <TerrainIcon fontSize="small" />,
    course: <ExploreIcon fontSize="small" />,
    ignition: <VpnKeyIcon fontSize="small" style={{ color: "#ffc107" }} />,
    motion: <DirectionsCarIcon fontSize="small" style={{ color: "#9c27b0" }} />,
    odometer: <AvTimerIcon fontSize="small" />,
    geofenceIds: <RoomIcon fontSize="small" />,
    sat: <LocationSearchingIcon fontSize="small" />,
    fuel: <LocalGasStationIcon fontSize="small" style={{ color: "#ff9800" }} />,
    charge: <PowerIcon fontSize="small" />,
    operator: <InfoOutlinedIcon fontSize="small" />,
    alarm: <AlarmIcon fontSize="small" style={{ color: "#f44336" }} />,
    status: <InfoOutlinedIcon fontSize="small" />,
    protocol: <CodeIcon fontSize="small" />,
  };

  const navigate = useNavigate();
  const dispatch = useDispatch();
  const t = useTranslation();

  const readonly = useRestriction("readonly");
  const deviceReadonly = useDeviceReadonly();

  const shareDisabled = useSelector(
    (state) => state.session.server.attributes.disableShare,
  );
  const user = useSelector((state) => state.session.user);
  const device = useSelector((state) => state.devices.items[deviceId]);

  const positionAttributes = usePositionAttributes(t);
  const positionItems = useAttributePreference(
    "positionItems",
    "fixTime,totalDistance,course,ignition,motion,odometer",
  );

  const navigationAppLink = useAttributePreference("navigationAppLink");
  const navigationAppTitle = useAttributePreference("navigationAppTitle");

  const [anchorEl, setAnchorEl] = useState(null);

  const [removing, setRemoving] = useState(false);

  const handleRemove = useCatch(async (removed) => {
    if (removed) {
      const response = await fetchOrThrow("/api/devices");
      dispatch(devicesActions.refresh(await response.json()));
    }
    setRemoving(false);
  });

  const handleGeofence = useCatchCallback(async () => {
    const newItem = {
      name: t("sharedGeofence"),
      area: `CIRCLE (${position.latitude} ${position.longitude}, 50)`,
    };
    const response = await fetchOrThrow("/api/geofences", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newItem),
    });
    const item = await response.json();
    await fetchOrThrow("/api/permissions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        deviceId: position.deviceId,
        geofenceId: item.id,
      }),
    });
    navigate(`/settings/geofence/${item.id}`);
  }, [navigate, position]);

  // Determine device status for chip
  const getStatusColor = (device, position) => {
    if (!position) return "default";
    if (position.attributes.ignition === true) return "success";
    if (position.speed > 0) return "info";
    return "warning";
  };

  const statusColor = position ? getStatusColor(device, position) : "default";
  const statusText = position
    ? position.attributes.ignition === true
      ? t("deviceEngineOn")
      : position.speed > 0
        ? t("deviceMoving")
        : t("deviceStopped")
    : t("deviceOffline");

  return (
    <>
      <div className={classes.root}>
        {device && (
          <Rnd
            default={{ x: 0, y: 0, width: "auto", height: "auto" }}
            enableResizing={false}
            dragHandleClassName="draggable-header"
            style={{ position: "relative" }}
          >
            <Card elevation={3} className={classes.card}>
              <div className={`${classes.header} draggable-header`}>
                <Box className={classes.headerContent}>
                  <Box className={classes.headerTopRow}>
                    <Typography variant="h6" className={classes.deviceName}>
                      {device.name}
                    </Typography>
                    {device.vehicle_number && (
                      <div className={classes.vehiclePlate}>
                        <VehicleNumberPlate number={device.vehicle_number} />
                      </div>
                    )}
                    <Chip
                      label={statusText}
                      size="small"
                      className={classes.statusChip}
                      color={statusColor}
                      variant="filled"
                    />
                  </Box>
                  <div className={classes.addressContainer}>
                    <RoomIcon
                      fontSize="small"
                      style={{ color: "#f44336", fontSize: "1rem" }}
                    />
                    <Typography
                      variant="body2"
                      color="text.secondary"
                      noWrap={false}
                      style={{ wordBreak: "break-word" }}
                    >
                      <AddressValue
                        latitude={position?.latitude}
                        longitude={position?.longitude}
                        originalAddress={position?.address}
                      />
                    </Typography>
                  </div>
                </Box>
                <IconButton
                  size="small"
                  onClick={onClose}
                  className={classes.headerButton}
                >
                  <CloseIcon />
                </IconButton>
              </div>
              {position && (
                <CardContent className={classes.content}>
                  <div className={classes.mainGrid}>
                    {/* Container for Speed Section and Data Section */}
                    <Box
                      sx={(theme) => ({
                        display: "flex",
                        flexDirection: "column",
                        overflowY: "auto", // Enable vertical scrolling for overflow content
                        padding: 1,
                        gap: 1,
                        width: "100%",
                        maxHeight: "calc(100% - 60px)", // Account for other elements
                        boxSizing: "border-box", // Ensure padding is included in width calculation
                        "&::-webkit-scrollbar": {
                          display: "none", // Hide scrollbar for cleaner look
                        },
                        scrollbarWidth: "none", // Firefox
                        msOverflowStyle: "none", // IE/Edge
                        [theme.breakpoints.down("sm")]: {
                          flexDirection: "column", // Keep as column for mobile to allow vertical scrolling of content
                          overflowY: "auto", // Enable vertical scrolling on mobile
                          width: "100%", // Ensure full width constraint
                        },
                        [theme.breakpoints.up("md")]: {
                          flexDirection: "row", // Horizontal layout on desktop
                          overflowX: "auto", // Horizontal scrolling on desktop if needed
                        },
                      })}
                    >
                      {/* Speed Section - Speed on left, mobile data box in center, battery/RSSI on right */}
                      <div className={classes.speedSection}>
                        {/* Speed Gauge on Left */}
                        <div className={classes.speedGaugeContainer} style={{ width: '100%' }}>
                          <Box
                            sx={{
                              display: "flex",
                              flexDirection: "column",
                              alignItems: "center",
                              justifyContent: "center",
                            }}
                          >
                            <Box className={classes.statIcon} sx={{ mb: 0.5 }}>
                              <SpeedIcon
                                fontSize="small"
                                style={{ color: "#4caf50", fontSize: "1.2rem" }}
                              />
                            </Box>
                            <Typography
                              variant="caption"
                              className={classes.statLabel}
                              sx={{ mb: 0.5 }}
                            >
                              {t("positionSpeed")}
                            </Typography>
                            <SpeedGauge speed={position.speed} />
                          </Box>
                        </div>

                        {/* Mobile Data Box - Battery, RSSI, Distance, and Time */}
                        <div className={classes.mobileDataBox} style={{ width: '100%' }}>
                          {/* Battery Level */}
                          <div className={classes.mobileDataItem}>
                            <BatteryIcon
                              batteryLevel={position.attributes.batteryLevel}
                              style={{ fontSize: "1rem", color: "#4caf50" }}
                            />
                            <Typography
                              variant="caption"
                              className={classes.mobileDataValue}
                            >
                              {position.attributes.batteryLevel !== undefined
                                ? `${position.attributes.batteryLevel}%`
                                : "-"}
                            </Typography>
                          </div>

                          {/* RSSI */}
                          <div className={classes.mobileDataItem}>
                            <RssiIcon
                              rssi={position.attributes.rssi}
                              style={{ fontSize: "1rem", color: "#ff9800" }}
                            />
                            <Typography
                              variant="caption"
                              className={classes.mobileDataValue}
                            >
                              {position.attributes.rssi !== undefined
                                ? `${position.attributes.rssi} dBm`
                                : "-"}
                            </Typography>
                          </div>

                          {/* Today Distance */}
                          {device.todayDistance !== undefined && (
                            <div className={classes.mobileDataItem}>
                              <DirectionsCarIcon
                                fontSize="small"
                                style={{ fontSize: "1rem", color: "#4caf50" }}
                              />
                              <Typography
                                variant="caption"
                                className={classes.mobileDataValue}
                              >
                                {formatDistance(
                                  device.todayDistance,
                                  distanceUnit,
                                  t,
                                )}
                              </Typography>
                            </div>
                          )}

                          {/* Today Start Time */}
                          {device.todayStartTime !== undefined && (
                            <div className={classes.mobileDataItem}>
                              <AccessTimeIcon
                                fontSize="small"
                                style={{ fontSize: "1rem", color: "#2196f3" }}
                              />
                              <Typography
                                variant="caption"
                                className={classes.mobileDataValue}
                              >
                                {formatTime(device.todayStartTime, "seconds")}
                              </Typography>
                            </div>
                          )}
                        </div>

                        {/* Removed duplicate battery and RSSI icons from right side */}
                      </div>

                      {/* Data Section - Additional Position Items Only */}
                      <div className={classes.dataGrid}>
                        {/* Additional Position Items Blocks */}
                        <div className={classes.dataRow} style={{ width: '100%', flexWrap: 'wrap', justifyContent: 'flex-start' }}>
                          {positionItems.split(",").map((key) => {
                            // Skip the address, speed, batteryLevel, rssi, todayDistance, and todayStartTime fields to prevent duplicate display
                            if (
                              key.trim() === "address" ||
                              key.trim() === "speed" ||
                              key.trim() === "batteryLevel" ||
                              key.trim() === "rssi" ||
                              key.trim() === "todayDistance" ||
                              key.trim() === "todayStartTime"
                            )
                              return null;
                            if (
                              !position.hasOwnProperty(key) &&
                              !position.attributes.hasOwnProperty(key)
                            )
                              return null;

                            return (
                              <div
                                key={key}
                                className={classes.statContainer}
                              >
                                <div className={classes.statItem}>
                                  {attributeIcons[key] && (
                                    <div className={classes.statIcon}>
                                      {attributeIcons[key]}
                                    </div>
                                  )}
                                  <Box>
                                    <Typography
                                      variant="caption"
                                      className={classes.statLabel}
                                    >
                                      {positionAttributes[key]?.name || key}
                                    </Typography>
                                    {(() => {
                                      if (
                                        key === "fixTime" ||
                                        key === "deviceTime" ||
                                        key === "serverTime"
                                      ) {
                                        return (
                                          <Box
                                            sx={{
                                              display: "flex",
                                              flexDirection: "column",
                                              width: "100%",
                                              mt: 0.2,
                                            }}
                                          >
                                            <Box
                                              sx={{
                                                backgroundColor: "#e3f2fd", // Light Blue
                                                color: "#1e88e5", // Darker Blue Text
                                                padding: "1px 2px",
                                                borderRadius: "3px",
                                                textAlign: "center",
                                                fontSize: "0.6rem",
                                              }}
                                            >
                                              <Typography
                                                variant="caption"
                                                sx={{
                                                  display: "block",
                                                  fontWeight: "bold",
                                                  fontSize: "0.6rem",
                                                }}
                                              >
                                                {dayjs(position[key]).format(
                                                  "DD/MMM/YYYY",
                                                )}
                                              </Typography>
                                            </Box>
                                            <Box
                                              sx={{
                                                backgroundColor: "#90caf9", // Medium Blue
                                                color: "#0d47a1", // Darkest Blue Text
                                                padding: "1px 2px",
                                                borderRadius: "3px",
                                                textAlign: "center",
                                                fontSize: "0.6rem",
                                                mt: 0.1,
                                              }}
                                            >
                                              <Typography
                                                variant="caption"
                                                sx={{
                                                  display: "block",
                                                  fontWeight: "bold",
                                                  fontSize: "0.6rem",
                                                }}
                                              >
                                                {dayjs(position[key]).format(
                                                  "hh:mm A",
                                                )}
                                              </Typography>
                                            </Box>
                                          </Box>
                                        );
                                      } else {
                                        return (
                                          <Typography
                                            variant="body2"
                                            className={classes.statValue}
                                            sx={{
                                              fontSize:
                                                key.trim() === "fixTime" ||
                                                key.trim() === "deviceTime" ||
                                                key.trim() === "serverTime"
                                                  ? "0.6rem"
                                                  : "0.8rem",
                                            }}
                                          >
                                            <PositionValue
                                              position={position}
                                              property={
                                                position.hasOwnProperty(key)
                                                  ? key
                                                  : null
                                              }
                                              attribute={
                                                position.hasOwnProperty(key)
                                                  ? null
                                                  : key
                                              }
                                            />
                                          </Typography>
                                        );
                                      }
                                    })()}
                                  </Box>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </Box>

                    <Box
                      sx={{
                        mt: 1,
                        display: "flex",
                        justifyContent: "flex-end",
                        width: "100%",
                      }}
                    >
                      <Link
                        component={RouterLink}
                        underline="hover"
                        to={`/position/${position.id}`}
                        variant="caption"
                        color="primary"
                      >
                        {t("sharedShowDetails")}
                      </Link>
                    </Box>
                  </div>
                </CardContent>
              )}
              <CardActions classes={{ root: classes.actions }} disableSpacing>
                <Tooltip title={t("mapOptions")}>
                  <IconButton
                    size="small"
                    onClick={(e) => setAnchorEl(e.currentTarget)}
                    disabled={!position}
                  >
                    <TuneIcon style={{ color: "#2196f3" }} />
                  </IconButton>
                </Tooltip>
                <Tooltip title={t("reportReplay")}>
                  <IconButton
                    size="small"
                    onClick={() => navigate(`/replay?deviceId=${deviceId}`)}
                    disabled={disableActions || !position}
                  >
                    <RouteIcon style={{ color: "#4caf50" }} />
                  </IconButton>
                </Tooltip>
                <Tooltip title={t("commandTitle")}>
                  <IconButton
                    size="small"
                    onClick={() =>
                      navigate(`/settings/device/${deviceId}/command`)
                    }
                    disabled={disableActions}
                  >
                    <SendIcon style={{ color: "#ff9800" }} />
                  </IconButton>
                </Tooltip>
                <Tooltip title={t("sharedEdit")}>
                  <IconButton
                    size="small"
                    onClick={() => navigate(`/settings/device/${deviceId}`)}
                    disabled={disableActions || deviceReadonly}
                  >
                    <EditIcon style={{ color: "#9c27b0" }} />
                  </IconButton>
                </Tooltip>
                <Tooltip title={t("sharedRemove")}>
                  <IconButton
                    size="small"
                    onClick={() => setRemoving(true)}
                    disabled={disableActions || deviceReadonly}
                  >
                    <DeleteIcon style={{ color: "#f44336" }} />
                  </IconButton>
                </Tooltip>
              </CardActions>
            </Card>
          </Rnd>
        )}
      </div>
      {position && (
        <Menu
          anchorEl={anchorEl}
          open={Boolean(anchorEl)}
          onClose={() => setAnchorEl(null)}
        >
          {!readonly && (
            <MenuItem onClick={handleGeofence}>
              {t("sharedCreateGeofence")}
            </MenuItem>
          )}
          <MenuItem
            component="a"
            target="_blank"
            href={`https://www.google.com/maps/search/?api=1&query=${position.latitude}%2C${position.longitude}`}
          >
            {t("linkGoogleMaps")}
          </MenuItem>
          <MenuItem
            component="a"
            target="_blank"
            href={`http://maps.apple.com/?ll=${position.latitude},${position.longitude}`}
          >
            {t("linkAppleMaps")}
          </MenuItem>
          <MenuItem
            component="a"
            target="_blank"
            href={`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${position.latitude}%2C${position.longitude}&heading=${position.course}`}
          >
            {t("linkStreetView")}
          </MenuItem>
          {navigationAppTitle && (
            <MenuItem
              component="a"
              target="_blank"
              href={navigationAppLink
                .replace("{latitude}", position.latitude)
                .replace("{longitude}", position.longitude)}
            >
              {navigationAppTitle}
            </MenuItem>
          )}
          {!shareDisabled && !user.temporary && (
            <MenuItem
              onClick={() => navigate(`/settings/device/${deviceId}/share`)}
            >
              <Typography color="secondary">{t("deviceShare")}</Typography>
            </MenuItem>
          )}
        </Menu>
      )}
      <RemoveDialog
        open={removing}
        endpoint="devices"
        itemId={deviceId}
        onResult={(removed) => handleRemove(removed)}
      />
    </>
  );
};

export default StatusCard;
